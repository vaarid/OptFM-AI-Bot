"""
FAQ Manager Module for OptFM AI Bot
"""
import json
import logging
import re
from typing import List, Dict, Optional, Tuple
from pathlib import Path

logger = logging.getLogger(__name__)

class FAQManager:
    """–ú–µ–Ω–µ–¥–∂–µ—Ä –¥–ª—è —Ä–∞–±–æ—Ç—ã —Å —á–∞—Å—Ç–æ –∑–∞–¥–∞–≤–∞–µ–º—ã–º–∏ –≤–æ–ø—Ä–æ—Å–∞–º–∏"""
    
    def __init__(self, faq_file: str = "data/faq.json"):
        """
        –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è FAQ –º–µ–Ω–µ–¥–∂–µ—Ä–∞
        
        Args:
            faq_file: –ü—É—Ç—å –∫ —Ñ–∞–π–ª—É —Å FAQ –¥–∞–Ω–Ω—ã–º–∏
        """
        self.faq_file = Path(faq_file)
        self.faq_data = []
        self._load_faq()
        
    def _load_faq(self):
        """–ó–∞–≥—Ä—É–∑–∫–∞ FAQ –¥–∞–Ω–Ω—ã—Ö –∏–∑ —Ñ–∞–π–ª–∞"""
        try:
            if self.faq_file.exists():
                with open(self.faq_file, 'r', encoding='utf-8') as f:
                    self.faq_data = json.load(f)
                logger.info(f"–ó–∞–≥—Ä—É–∂–µ–Ω–æ {len(self.faq_data)} FAQ –∑–∞–ø–∏—Å–µ–π")
            else:
                logger.warning(f"FAQ —Ñ–∞–π–ª –Ω–µ –Ω–∞–π–¥–µ–Ω: {self.faq_file}")
                self.faq_data = self._get_default_faq()
        except Exception as e:
            logger.error(f"–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ FAQ: {e}")
            self.faq_data = self._get_default_faq()
    
    def _get_default_faq(self) -> List[Dict]:
        """–í–æ–∑–≤—Ä–∞—â–∞–µ—Ç –±–∞–∑–æ–≤—ã–π –Ω–∞–±–æ—Ä FAQ –¥–ª—è OptFM"""
        return [
            {
                "id": 1,
                "question": "–ö–∞–∫–∏–µ –ø—Ä–æ–¥—É–∫—Ç—ã –≤—ã –ø—Ä–µ–¥–ª–∞–≥–∞–µ—Ç–µ?",
                "keywords": ["–ø—Ä–æ–¥—É–∫—Ç—ã", "—Ç–æ–≤–∞—Ä—ã", "–∞—Å—Å–æ—Ä—Ç–∏–º–µ–Ω—Ç", "—á—Ç–æ –ø—Ä–æ–¥–∞–µ—Ç–µ", "–∫–∞—Ç–∞–ª–æ–≥", "–µ—Å—Ç—å", "–ø—Ä–µ–¥–ª–∞–≥–∞–µ—Ç–µ", "–ø—Ä–æ–¥–∞–µ—Ç–µ"],
                "answer": "–ö–æ–º–ø–∞–Ω–∏—è OptFM –ø—Ä–µ–¥–ª–∞–≥–∞–µ—Ç —à–∏—Ä–æ–∫–∏–π –∞—Å—Å–æ—Ä—Ç–∏–º–µ–Ω—Ç –ø—Ä–æ–¥—É–∫—Ç–æ–≤ –¥–ª—è –≤–∞—à–µ–≥–æ –±–∏–∑–Ω–µ—Å–∞. –£ –Ω–∞—Å –µ—Å—Ç—å:\n\n‚Ä¢ –ü—Ä–æ–º—ã—à–ª–µ–Ω–Ω–æ–µ –æ–±–æ—Ä—É–¥–æ–≤–∞–Ω–∏–µ\n‚Ä¢ –≠–ª–µ–∫—Ç—Ä–æ–Ω–Ω—ã–µ –∫–æ–º–ø–æ–Ω–µ–Ω—Ç—ã\n‚Ä¢ –ò–Ω—Å—Ç—Ä—É–º–µ–Ω—Ç—ã –∏ –º–∞—Ç–µ—Ä–∏–∞–ª—ã\n‚Ä¢ –°–ø–µ—Ü–∏–∞–ª–∏–∑–∏—Ä–æ–≤–∞–Ω–Ω—ã–µ —Ä–µ—à–µ–Ω–∏—è\n\n–î–ª—è –ø–æ–ª—É—á–µ–Ω–∏—è –∞–∫—Ç—É–∞–ª—å–Ω–æ–≥–æ –ø—Ä–∞–π—Å–∞ –∏ –ø–æ–¥—Ä–æ–±–Ω–æ–π –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏–∏, –Ω–∞–ø–∏—à–∏—Ç–µ –≤–∞—à –∫–æ–Ω–∫—Ä–µ—Ç–Ω—ã–π –∑–∞–ø—Ä–æ—Å."
            },
            {
                "id": 2,
                "question": "–ö–∞–∫ —Å –≤–∞–º–∏ —Å–≤—è–∑–∞—Ç—å—Å—è?",
                "keywords": ["–∫–æ–Ω—Ç–∞–∫—Ç—ã", "—Å–≤—è–∑–∞—Ç—å—Å—è", "—Ç–µ–ª–µ—Ñ–æ–Ω", "email", "–∞–¥—Ä–µ—Å", "–≥–¥–µ –Ω–∞—Ö–æ–¥–∏—Ç–µ—Å—å"],
                "answer": "–°–≤—è–∑–∞—Ç—å—Å—è —Å OptFM –º–æ–∂–Ω–æ —Å–ª–µ–¥—É—é—â–∏–º–∏ —Å–ø–æ—Å–æ–±–∞–º–∏:\n\nüìû –¢–µ–ª–µ—Ñ–æ–Ω: +7 (XXX) XXX-XX-XX\nüìß Email: info@optfm.ru\nüåê –°–∞–π—Ç: www.optfm.ru\nüìç –ê–¥—Ä–µ—Å: [–ê–¥—Ä–µ—Å –æ—Ñ–∏—Å–∞]\n\n‚è∞ –†–µ–∂–∏–º —Ä–∞–±–æ—Ç—ã: –ü–Ω-–ü—Ç 9:00-18:00\n\n–î–ª—è —Å—Ä–æ—á–Ω—ã—Ö –≤–æ–ø—Ä–æ—Å–æ–≤ –æ—Å—Ç–∞–≤—å—Ç–µ –∑–∞—è–≤–∫—É, –∏ –Ω–∞—à –º–µ–Ω–µ–¥–∂–µ—Ä —Å–≤—è–∂–µ—Ç—Å—è —Å –≤–∞–º–∏ –≤ –±–ª–∏–∂–∞–π—à–µ–µ –≤—Ä–µ–º—è."
            },
            {
                "id": 3,
                "question": "–ö–∞–∫–∏–µ —É –≤–∞—Å —Ü–µ–Ω—ã?",
                "keywords": ["—Ü–µ–Ω—ã", "—Å—Ç–æ–∏–º–æ—Å—Ç—å", "–ø—Ä–∞–π—Å", "—Å–∫–æ–ª—å–∫–æ —Å—Ç–æ–∏—Ç", "—Ü–µ–Ω–∞", "—É –≤–∞—Å", "–≤–∞—à–∏", "—Å—Ç–æ–∏—Ç"],
                "answer": "–¶–µ–Ω—ã –Ω–∞ –Ω–∞—à–∏ –ø—Ä–æ–¥—É–∫—Ç—ã –∑–∞–≤–∏—Å—è—Ç –æ—Ç –æ–±—ä–µ–º–∞ –∑–∞–∫–∞–∑–∞, —Å–ø–µ—Ü–∏—Ñ–∏–∫–∞—Ü–∏–∏ –∏ —Ç–µ–∫—É—â–∏—Ö —Ä—ã–Ω–æ—á–Ω—ã—Ö —É—Å–ª–æ–≤–∏–π. –î–ª—è –ø–æ–ª—É—á–µ–Ω–∏—è –∞–∫—Ç—É–∞–ª—å–Ω–æ–≥–æ –ø—Ä–∞–π—Å–∞:\n\n‚Ä¢ –£–∫–∞–∂–∏—Ç–µ –∫–æ–Ω–∫—Ä–µ—Ç–Ω—ã–π –ø—Ä–æ–¥—É–∫—Ç –∏–ª–∏ –∫–∞—Ç–µ–≥–æ—Ä–∏—é\n‚Ä¢ –°–æ–æ–±—â–∏—Ç–µ —Ç—Ä–µ–±—É–µ–º–æ–µ –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ\n‚Ä¢ –£–∫–∞–∂–∏—Ç–µ —Å—Ä–æ–∫–∏ –ø–æ—Å—Ç–∞–≤–∫–∏\n\n–Ø –ø–æ–º–æ–≥—É –Ω–∞–π—Ç–∏ –ø–æ–¥—Ö–æ–¥—è—â–∏–µ –≤–∞—Ä–∏–∞–Ω—Ç—ã –∏ –ø–µ—Ä–µ–¥–∞–º –≤–∞—à –∑–∞–ø—Ä–æ—Å –º–µ–Ω–µ–¥–∂–µ—Ä—É –¥–ª—è —Ä–∞—Å—á–µ—Ç–∞."
            },
            {
                "id": 4,
                "question": "–ï—Å—Ç—å –ª–∏ –¥–æ—Å—Ç–∞–≤–∫–∞?",
                "keywords": ["–¥–æ—Å—Ç–∞–≤–∫–∞", "–æ—Ç–ø—Ä–∞–≤–∫–∞", "—Ç—Ä–∞–Ω—Å–ø–æ—Ä—Ç", "–∫—É—Ä—å–µ—Ä", "—Å–∞–º–æ–≤—ã–≤–æ–∑"],
                "answer": "–î–∞, OptFM –ø—Ä–µ–¥–æ—Å—Ç–∞–≤–ª—è–µ—Ç —Ä–∞–∑–ª–∏—á–Ω—ã–µ –≤–∞—Ä–∏–∞–Ω—Ç—ã –¥–æ—Å—Ç–∞–≤–∫–∏:\n\nüöö –î–æ—Å—Ç–∞–≤–∫–∞ –ø–æ –≥–æ—Ä–æ–¥—É\nüì¶ –û—Ç–ø—Ä–∞–≤–∫–∞ –≤ —Ä–µ–≥–∏–æ–Ω—ã\nüè™ –°–∞–º–æ–≤—ã–≤–æ–∑ —Å–æ —Å–∫–ª–∞–¥–∞\n\n–°—Ç–æ–∏–º–æ—Å—Ç—å –∏ —Å—Ä–æ–∫–∏ –¥–æ—Å—Ç–∞–≤–∫–∏ –∑–∞–≤–∏—Å—è—Ç –æ—Ç:\n‚Ä¢ –ú–µ—Å—Ç–∞ –Ω–∞–∑–Ω–∞—á–µ–Ω–∏—è\n‚Ä¢ –í–µ—Å–∞ –∏ –≥–∞–±–∞—Ä–∏—Ç–æ–≤\n‚Ä¢ –°—Ä–æ—á–Ω–æ—Å—Ç–∏\n\n–£—Ç–æ—á–Ω–∏—Ç–µ –¥–µ—Ç–∞–ª–∏ –∑–∞–∫–∞–∑–∞, –∏ —è –ø—Ä–µ–¥–æ—Å—Ç–∞–≤–ª—é –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—é –ø–æ –¥–æ—Å—Ç–∞–≤–∫–µ."
            },
            {
                "id": 5,
                "question": "–ö–∞–∫–∏–µ –≥–∞—Ä–∞–Ω—Ç–∏–∏ –≤—ã –ø—Ä–µ–¥–æ—Å—Ç–∞–≤–ª—è–µ—Ç–µ?",
                "keywords": ["–≥–∞—Ä–∞–Ω—Ç–∏—è", "–≤–æ–∑–≤—Ä–∞—Ç", "–æ–±–º–µ–Ω", "–∫–∞—á–µ—Å—Ç–≤–æ", "—Å–µ—Ä–≤–∏—Å", "–∫–∞—á–µ—Å—Ç–≤", "–≥–∞—Ä–∞–Ω—Ç–∏"],
                "answer": "OptFM –ø—Ä–µ–¥–æ—Å—Ç–∞–≤–ª—è–µ—Ç –ø–æ–ª–Ω—É—é –≥–∞—Ä–∞–Ω—Ç–∏—é –Ω–∞ –≤—Å–µ –ø—Ä–æ–¥—É–∫—Ç—ã:\n\n‚úÖ –ì–∞—Ä–∞–Ω—Ç–∏–π–Ω—ã–π —Å—Ä–æ–∫ —Å–æ–≥–ª–∞—Å–Ω–æ —Ç–µ—Ö–Ω–∏—á–µ—Å–∫–∏–º —É—Å–ª–æ–≤–∏—è–º\n‚úÖ –í–æ–∑–º–æ–∂–Ω–æ—Å—Ç—å –≤–æ–∑–≤—Ä–∞—Ç–∞ –≤ —Ç–µ—á–µ–Ω–∏–µ 14 –¥–Ω–µ–π\n‚úÖ –¢–µ—Ö–Ω–∏—á–µ—Å–∫–∞—è –ø–æ–¥–¥–µ—Ä–∂–∫–∞\n‚úÖ –°–µ—Ä–≤–∏—Å–Ω–æ–µ –æ–±—Å–ª—É–∂–∏–≤–∞–Ω–∏–µ\n\n–í—Å–µ —Ç–æ–≤–∞—Ä—ã —Å–µ—Ä—Ç–∏—Ñ–∏—Ü–∏—Ä–æ–≤–∞–Ω—ã –∏ —Å–æ–æ—Ç–≤–µ—Ç—Å—Ç–≤—É—é—Ç —Ä–æ—Å—Å–∏–π—Å–∫–∏–º —Å—Ç–∞–Ω–¥–∞—Ä—Ç–∞–º –∫–∞—á–µ—Å—Ç–≤–∞."
            },
            {
                "id": 6,
                "question": "–†–∞–±–æ—Ç–∞–µ—Ç–µ –ª–∏ –≤—ã —Å —é—Ä–∏–¥–∏—á–µ—Å–∫–∏–º–∏ –ª–∏—Ü–∞–º–∏?",
                "keywords": ["—é—Ä–∏–¥–∏—á–µ—Å–∫–∏–µ –ª–∏—Ü–∞", "–æ—Ä–≥–∞–Ω–∏–∑–∞—Ü–∏–∏", "–∫–æ–º–ø–∞–Ω–∏–∏", "–±–∏–∑–Ω–µ—Å", "–æ–ø—Ç"],
                "answer": "–î–∞, OptFM —Ä–∞–±–æ—Ç–∞–µ—Ç –∫–∞–∫ —Å —Ñ–∏–∑–∏—á–µ—Å–∫–∏–º–∏, —Ç–∞–∫ –∏ —Å —é—Ä–∏–¥–∏—á–µ—Å–∫–∏–º–∏ –ª–∏—Ü–∞–º–∏:\n\nüè¢ –î–ª—è –æ—Ä–≥–∞–Ω–∏–∑–∞—Ü–∏–π:\n‚Ä¢ –ë–µ–∑–Ω–∞–ª–∏—á–Ω—ã–π —Ä–∞—Å—á–µ—Ç\n‚Ä¢ –î–æ–≥–æ–≤–æ—Ä–Ω—ã–µ –æ—Ç–Ω–æ—à–µ–Ω–∏—è\n‚Ä¢ –°–ø–µ—Ü–∏–∞–ª—å–Ω—ã–µ —É—Å–ª–æ–≤–∏—è –¥–ª—è –ø–æ—Å—Ç–æ—è–Ω–Ω—ã—Ö –∫–ª–∏–µ–Ω—Ç–æ–≤\n‚Ä¢ –û—Ç—Å—Ä–æ—á–∫–∞ –ø–ª–∞—Ç–µ–∂–∞ (–ø–æ —Å–æ–≥–ª–∞—Å–æ–≤–∞–Ω–∏—é)\n\nüë§ –î–ª—è —á–∞—Å—Ç–Ω—ã—Ö –ª–∏—Ü:\n‚Ä¢ –ù–∞–ª–∏—á–Ω—ã–π –∏ –±–µ–∑–Ω–∞–ª–∏—á–Ω—ã–π —Ä–∞—Å—á–µ—Ç\n‚Ä¢ –£–¥–æ–±–Ω—ã–µ —Å–ø–æ—Å–æ–±—ã –æ–ø–ª–∞—Ç—ã\n\n–û—Å—Ç–∞–≤—å—Ç–µ –∑–∞—è–≤–∫—É, –∏ –º–µ–Ω–µ–¥–∂–µ—Ä —Å–≤—è–∂–µ—Ç—Å—è –¥–ª—è –æ–±—Å—É–∂–¥–µ–Ω–∏—è —É—Å–ª–æ–≤–∏–π —Å–æ—Ç—Ä—É–¥–Ω–∏—á–µ—Å—Ç–≤–∞."
            }
        ]
    
    def search_faq(self, query: str) -> Optional[Dict]:
        """
        –ü–æ–∏—Å–∫ –æ—Ç–≤–µ—Ç–∞ –≤ FAQ –ø–æ –∑–∞–ø—Ä–æ—Å—É
        
        Args:
            query: –ü–æ–∏—Å–∫–æ–≤—ã–π –∑–∞–ø—Ä–æ—Å –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
            
        Returns:
            Dict —Å –Ω–∞–π–¥–µ–Ω–Ω—ã–º FAQ –∏–ª–∏ None
        """
        if not query or not self.faq_data:
            return None
        
        # –ù–æ—Ä–º–∞–ª–∏–∑–∞—Ü–∏—è –∑–∞–ø—Ä–æ—Å–∞
        query_lower = query.lower().strip()
        query_words = re.findall(r'\w+', query_lower)
        
        logger.info(f"–ü–æ–∏—Å–∫ FAQ –¥–ª—è –∑–∞–ø—Ä–æ—Å–∞: '{query}' (—Å–ª–æ–≤–∞: {query_words})")
        
        # –ü–æ–∏—Å–∫ –ø–æ —Ç–æ—á–Ω–æ–º—É —Å–æ–≤–ø–∞–¥–µ–Ω–∏—é –≤–æ–ø—Ä–æ—Å–∞
        for faq in self.faq_data:
            if query_lower in faq["question"].lower():
                logger.info(f"–ù–∞–π–¥–µ–Ω–æ —Ç–æ—á–Ω–æ–µ —Å–æ–≤–ø–∞–¥–µ–Ω–∏–µ: {faq['id']}")
                return faq
        
        # –ü–æ–∏—Å–∫ –ø–æ –∫–ª—é—á–µ–≤—ã–º —Å–ª–æ–≤–∞–º
        best_match = None
        best_score = 0
        
        for faq in self.faq_data:
            score = self._calculate_keyword_score(query_words, faq["keywords"])
            logger.info(f"FAQ {faq['id']} - score: {score:.2f} (keywords: {faq['keywords']})")
            if score > best_score:
                best_score = score
                best_match = faq
        
        # –°–Ω–∏–∂–∞–µ–º –ø–æ—Ä–æ–≥ —Ä–µ–ª–µ–≤–∞–Ω—Ç–Ω–æ—Å—Ç–∏ –¥–ª—è –ª—É—á—à–µ–≥–æ –ø–æ–∏—Å–∫–∞
        if best_score >= 0.1:  # –ë–æ–ª–µ–µ –º—è–≥–∫–∏–π –ø–æ—Ä–æ–≥
            logger.info(f"–ù–∞–π–¥–µ–Ω–æ —Å–æ–≤–ø–∞–¥–µ–Ω–∏–µ –ø–æ –∫–ª—é—á–µ–≤—ã–º —Å–ª–æ–≤–∞–º: {best_match['id']} (score: {best_score:.2f})")
            return best_match
        
        logger.info(f"–°–æ–≤–ø–∞–¥–µ–Ω–∏–π –Ω–µ –Ω–∞–π–¥–µ–Ω–æ (–ª—É—á—à–∏–π score: {best_score:.2f})")
        return None
    
    def _calculate_keyword_score(self, query_words: List[str], keywords: List[str]) -> float:
        """
        –í—ã—á–∏—Å–ª–µ–Ω–∏–µ —Ä–µ–ª–µ–≤–∞–Ω—Ç–Ω–æ—Å—Ç–∏ –∑–∞–ø—Ä–æ—Å–∞ –∫ –∫–ª—é—á–µ–≤—ã–º —Å–ª–æ–≤–∞–º
        
        Args:
            query_words: –°–ª–æ–≤–∞ –∏–∑ –∑–∞–ø—Ä–æ—Å–∞
            keywords: –°–ø–∏—Å–æ–∫ –∫–ª—é—á–µ–≤—ã—Ö —Å–ª–æ–≤
            
        Returns:
            –û—Ü–µ–Ω–∫–∞ —Ä–µ–ª–µ–≤–∞–Ω—Ç–Ω–æ—Å—Ç–∏ –æ—Ç 0 –¥–æ 1
        """
        if not keywords or not query_words:
            return 0.0
        
        # –ü–æ–¥—Å—á–∏—Ç—ã–≤–∞–µ–º —Å–æ–≤–ø–∞–¥–µ–Ω–∏—è
        matches = 0
        total_keywords = len(keywords)
        
        for keyword in keywords:
            keyword_lower = keyword.lower()
            for word in query_words:
                # –ü—Ä–æ–≤–µ—Ä—è–µ–º —Ä–∞–∑–ª–∏—á–Ω—ã–µ –≤–∞—Ä–∏–∞–Ω—Ç—ã —Å–æ–≤–ø–∞–¥–µ–Ω–∏–π
                if (keyword_lower == word or 
                    keyword_lower in word or 
                    word in keyword_lower or
                    keyword_lower.startswith(word) or
                    word.startswith(keyword_lower)):
                    matches += 1
                    break
        
        score = matches / total_keywords if total_keywords > 0 else 0.0
        return score
    
    def get_all_faq(self) -> List[Dict]:
        """–í–æ–∑–≤—Ä–∞—â–∞–µ—Ç –≤—Å–µ FAQ –∑–∞–ø–∏—Å–∏"""
        return self.faq_data.copy()
    
    def add_faq(self, question: str, answer: str, keywords: List[str] = None) -> bool:
        """
        –î–æ–±–∞–≤–ª–µ–Ω–∏–µ –Ω–æ–≤–æ–≥–æ FAQ
        
        Args:
            question: –í–æ–ø—Ä–æ—Å
            answer: –û—Ç–≤–µ—Ç
            keywords: –ö–ª—é—á–µ–≤—ã–µ —Å–ª–æ–≤–∞
            
        Returns:
            True –µ—Å–ª–∏ –¥–æ–±–∞–≤–ª–µ–Ω–æ —É—Å–ø–µ—à–Ω–æ
        """
        try:
            new_id = max([faq["id"] for faq in self.faq_data], default=0) + 1
            new_faq = {
                "id": new_id,
                "question": question,
                "answer": answer,
                "keywords": keywords or []
            }
            
            self.faq_data.append(new_faq)
            self._save_faq()
            logger.info(f"–î–æ–±–∞–≤–ª–µ–Ω –Ω–æ–≤—ã–π FAQ: {new_id}")
            return True
            
        except Exception as e:
            logger.error(f"–û—à–∏–±–∫–∞ –¥–æ–±–∞–≤–ª–µ–Ω–∏—è FAQ: {e}")
            return False
    
    def _save_faq(self):
        """–°–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ FAQ –≤ —Ñ–∞–π–ª"""
        try:
            # –°–æ–∑–¥–∞–µ–º –¥–∏—Ä–µ–∫—Ç–æ—Ä–∏—é –µ—Å–ª–∏ –Ω–µ —Å—É—â–µ—Å—Ç–≤—É–µ—Ç
            self.faq_file.parent.mkdir(parents=True, exist_ok=True)
            
            with open(self.faq_file, 'w', encoding='utf-8') as f:
                json.dump(self.faq_data, f, ensure_ascii=False, indent=2)
                
            logger.info(f"FAQ —Å–æ—Ö—Ä–∞–Ω–µ–Ω –≤ {self.faq_file}")
            
        except Exception as e:
            logger.error(f"–û—à–∏–±–∫–∞ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏—è FAQ: {e}")

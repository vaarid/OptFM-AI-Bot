# Vision: OptFM AI Bot

## Цель
Создать интеллектуального бота для OptFM, работающего 24/7 в Telegram и на сайте компании.  
Бот отвечает на частые вопросы, использует актуальный прайс через RAG, а при сложных запросах перенаправляет пользователя менеджеру.

---

## 1. Технологии
- **Язык**: Python 3.11+
- **Фреймворк**: FastAPI (backend API для интеграций)
- **БД**: PostgreSQL (хранение диалогов, заявок, логов)
- **LLM**: Ollama (локальные модели) или российские AI (YandexGPT, SberAI)
- **RAG**: ChromaDB / Weaviate (векторная БД для поиска по прайсу и FAQ)
- **Интеграции**:  
  - Telegram Bot API  
  - Web-чат виджет (JS + REST API)  
  - CRM (через REST / Webhooks, в будущем)
- **Деплой**: Docker + docker-compose  
- **CI/CD**: GitHub Actions (по желанию)

---

## 2. Архитектура проекта
```plaintext
[Пользователь]
   │
   ├── Telegram → Bot API
   │
   ├── Web-чат → Frontend Widget → FastAPI backend
   │
[FastAPI backend]
   │
   ├── RAG (ChromaDB + прайс OptFM)
   ├── LLM (Ollama / YandexGPT / SberAI)
   ├── PostgreSQL (контакты, заявки, диалоги)
   └── Логирование + мониторинг
```

---

## 3. Принцип разработки
- **MVP первым делом**: эхо-бот + FAQ из статической базы.  
- Итеративное развитие: добавляем RAG, память, логирование, CRM.  
- Принципы: **KISS, YAGNI, MVP, Fail Fast**.  

---

## 4. Структура проекта
```plaintext
optfm_bot/
├── src/
│   ├── main.py          # точка входа
│   ├── api/             # обработчики API
│   ├── bot/             # Telegram логика
│   ├── web/             # виджет и роуты сайта
│   ├── rag/             # модуль поиска по прайсу
│   └── db/              # работа с PostgreSQL
├── docs/
│   ├── intro.md
│   ├── guides/
│   └── ADR/
├── .cursor/rules/
├── docker-compose.yml
└── README.md
```

---

## 5. Модель данных
- **User**: id, имя, контакты, источник (Telegram/Web)
- **Dialog**: user_id, история сообщений, дата
- **Request**: категория товара, статус, ответ/передача менеджеру
- **Log**: тип события, сообщение, время

---

## 6. Работа с LLM
- Универсальный интерфейс через **OpenAI API совместимый клиент**.
- Поддержка:
  - **Ollama** для локальных моделей (LLaMA, Mistral, Gemma).  
  - Российские модели (ЯндексGPT, СберAI) через REST API.
- Вызовы LLM всегда идут через middleware → логирование + оптимизация токенов.

---

## 7. Мониторинг и логирование
- Логирование в PostgreSQL + файловый `logs/app.log`.  
- Метрики (через Prometheus/Grafana).  
- Статистика: количество диалогов, запросов к LLM, время ответа.  

---

## 8. Сценарии работы
1. Пользователь задаёт вопрос.  
2. Бот проверяет:  
   - FAQ → если найден ответ, вернуть сразу.  
   - RAG → поиск в прайсе, выдать цену/описание.  
   - Если нет → бот предлагает оставить контакты.  
3. При передаче менеджеру → запись в БД + уведомление.  
4. Менеджер продолжает общение вручную.  

---

## 9. Деплой
- **Docker Compose**:  
  - `backend (FastAPI)`  
  - `postgres`  
  - `chromadb`  
  - `ollama` (или подключение к российскому AI API)  
- В будущем: Kubernetes (для масштабирования).  

---

## 10. Конфигурация
- Переменные окружения в `.env`:  
  - `TELEGRAM_BOT_TOKEN`  
  - `DB_URL`  
  - `AI_PROVIDER` (ollama / yandex / sber)  
  - `CRM_API_KEY`  

---

## 11. Логирование
- Все события фиксируются:
  - входящие запросы,  
  - ответы модели,  
  - ошибки.  
- Ошибки дублируются в `error.log`.  

---

## Итог
Проект OptFM AI Bot будет иметь **два канала (Telegram + Web)**, поддержку **Ollama/российских AI**, а также модуль RAG для актуального прайса.  
Итеративный подход позволит начать с простого MVP и постепенно расширять функциональность без оверинжиниринга.

# Заметки по проекту OptFM

## Планы развития

### Итерация 1: Базовая функциональность ✅
- [x] Создание Telegram бота
- [x] Интеграция с FAQ системой
- [x] Базовая обработка сообщений

### Итерация 2: Улучшение FAQ ✅
- [x] Интерактивные кнопки для FAQ
- [x] Поиск по ключевым словам
- [x] Пагинация результатов

### Итерация 3: RAG для прайс-листа ✅
- [x] Парсинг Excel файла с прайс-листом
- [x] Интеграция с ChromaDB
- [x] Поиск по товарам и производителям
- [x] Скрытие цен (заглушка)

### Итерация 3.1: Интеграция RAG в бота ✅
- [x] Подключение RAG к Telegram боту
- [x] Новые команды для поиска товаров
- [x] Интерактивная навигация
- [x] Поиск по категориям и производителям

### Итерация 3.2: Улучшение UX поиска ✅
- [x] Интерактивный режим поиска
- [x] Умные кнопки навигации
- [x] Улучшенная логика поиска производителей
- [x] Более вежливые приветствия

### Итерация 3.3: Исправление багов ✅
- [x] Исправлен баг с отображением неправильных товаров при клике на кнопки
- [x] Добавлен метод get_product_by_id для точного поиска по ID
- [x] Улучшена логика обработки callback'ов в боте

### Итерация 3.4: Решение проблем запуска ✅
- [x] Исправлен конфликт экземпляров бота
- [x] Решена проблема с Button_data_invalid
- [x] Обеспечена корректная работа нового интерфейса

## Следующие шаги

### Итерация 4: Интеграция с LLM
- [ ] Подключение языковой модели для генерации ответов
- [ ] Улучшение качества поиска
- [ ] Контекстные ответы

### Итерация 5: API для обновления прайс-листа
- [ ] REST API для загрузки новых прайс-листов
- [ ] Автоматическое обновление базы данных
- [ ] Версионирование прайс-листов

### Итерация 6: Логирование и аналитика
- [ ] Детальное логирование запросов
- [ ] Аналитика использования бота
- [ ] Мониторинг производительности

## Технические детали

### Архитектура RAG
- **Парсер**: `src/rag/price_parser.py` - парсит Excel файлы
- **Эмбеддинги**: `src/rag/embeddings_manager.py` - управляет векторными представлениями
- **Менеджер**: `src/rag/product_rag_manager.py` - основная логика поиска
- **База данных**: ChromaDB для хранения векторов

### Используемые технологии
- **FastAPI**: веб-сервер
- **python-telegram-bot**: Telegram бот
- **ChromaDB**: векторная база данных
- **sentence-transformers**: модели эмбеддингов
- **pandas/openpyxl**: работа с Excel файлами

## Проблемы и решения

### Проблема 1: Неправильное отображение товаров при клике на кнопки
**Описание**: При поиске "наушники" и клике на кнопку товара показывался товар "автовизитка" вместо наушников.

**Причина**: В обработчике callback'ов использовался метод `search_products` вместо точного поиска по ID.

**Решение**: 
1. Добавлен метод `get_product_by_id` в `ProductRAGManager`
2. Изменен обработчик `product_` callback'ов в боте для использования нового метода
3. Теперь товары отображаются корректно по их точному ID

**Дата исправления**: 02.09.2025

### Проблема 2: Конфликт экземпляров бота
**Описание**: Ошибка `Conflict: terminated by other getUpdates request; make sure that only one bot instance is running`

**Причина**: Запущено несколько экземпляров бота одновременно.

**Решение**: 
1. Полная остановка всех процессов Python: `taskkill /f /im python.exe`
2. Проверка отсутствия процессов: `Get-Process python -ErrorAction SilentlyContinue`
3. Запуск единственного экземпляра бота

**Дата исправления**: 02.09.2025

### Проблема 3: Ошибка Button_data_invalid
**Описание**: Ошибка при обработке callback'ов для категорий.

**Причина**: Проблемы с форматом callback данных в интерактивных кнопках.

**Решение**: 
1. Проверка и исправление формата callback данных
2. Обеспечение корректной работы всех интерактивных кнопок
3. Улучшение обработки ошибок в callback'ах

**Дата исправления**: 02.09.2025

## Заметки по разработке

### Важные моменты
- Всегда использовать точный поиск по ID для отображения деталей товара
- ChromaDB не поддерживает сложные фильтры в where clause
- Необходимо применять пост-обработку для фильтрации по производителям
- Цены скрыты заглушкой "Уточняйте у менеджера"
- **ВАЖНО**: Запускать только один экземпляр бота одновременно

### Рекомендации
- Регулярно тестировать поиск и отображение товаров
- Мониторить качество поиска по производителям
- Рассмотреть возможность кэширования популярных запросов
- При проблемах с ботом всегда проверять наличие множественных экземпляров
- Использовать `taskkill /f /im python.exe` для полной остановки всех процессов

### Процедура перезапуска бота
1. Остановить все процессы Python: `taskkill /f /im python.exe`
2. Проверить отсутствие процессов: `Get-Process python -ErrorAction SilentlyContinue`
3. Запустить бота: `python run_bot.py`
4. Проверить логи на наличие ошибок
